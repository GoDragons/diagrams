{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Transform": "AWS::Serverless-2016-10-31",
    "Description": "API for an online collaboration tool used to build system design diagrams",
    "Parameters": {
        "ConnectionsTable": {
            "Type": "String",
            "Default": "diagrams_app_connections",
            "Description": "(Required) The name of the new DynamoDB to store connection identifiers for each connected clients. Minimum 3 characters",
            "MinLength": 3,
            "MaxLength": 50,
            "AllowedPattern": "^[A-Za-z_]+$",
            "ConstraintDescription": "Required. Can be characters and underscore only. No numbers or special characters allowed."
        },
        "DiagramsTable": {
            "Type": "String",
            "Default": "diagrams_app_diagrams",
            "Description": "(Required) The name of the new DynamoDB to store connection identifiers for each connected clients. Minimum 3 characters",
            "MinLength": 3,
            "MaxLength": 50,
            "AllowedPattern": "^[A-Za-z_]+$",
            "ConstraintDescription": "Required. Can be characters and underscore only. No numbers or special characters allowed."
        }
    },
    "Resources": {
        "Diagrams": {
            "Type": "AWS::ApiGatewayV2::Api",
            "Properties": {
                "Name": "Diagrams",
                "ProtocolType": "WEBSOCKET",
                "RouteSelectionExpression": "$request.body.message"
            }
        },
        "ConnectionsDBTable": {
            "Type": "AWS::DynamoDB::Table",
            "Properties": {
                "AttributeDefinitions": [
                    {
                        "AttributeName": "connectionId",
                        "AttributeType": "S"
                    }
                ],
                "KeySchema": [
                    {
                        "AttributeName": "connectionId",
                        "KeyType": "HASH"
                    }
                ],
                "ProvisionedThroughput": {
                    "ReadCapacityUnits": 1,
                    "WriteCapacityUnits": 1
                },
                "SSESpecification": {
                    "SSEEnabled": true
                },
                "TableName": {
                    "Ref": "ConnectionsTable"
                }
            }
        },
        "DiagramsDBTable": {
            "Type": "AWS::DynamoDB::Table",
            "Properties": {
                "AttributeDefinitions": [
                    {
                        "AttributeName": "diagramId",
                        "AttributeType": "S"
                    }
                ],
                "KeySchema": [
                    {
                        "AttributeName": "diagramId",
                        "KeyType": "HASH"
                    }
                ],
                "ProvisionedThroughput": {
                    "ReadCapacityUnits": 1,
                    "WriteCapacityUnits": 1
                },
                "SSESpecification": {
                    "SSEEnabled": true
                },
                "TableName": {
                    "Ref": "DiagramsTable"
                }
            }
        },
        "Deployment": {
            "Type": "AWS::ApiGatewayV2::Deployment",
            "DependsOn": [
                "CreateDiagramRoute",
                "GetDiagramsRoute",
                "SendMessageRoute",
                "DisconnectRoute",
                "ConnectRoute"
            ],
            "Properties": {
                "ApiId": {
                    "Ref": "Diagrams"
                }
            }
        },
        "Stage": {
            "Type": "AWS::ApiGatewayV2::Stage",
            "Properties": {
                "StageName": "Prod",
                "Description": "Prod Stage",
                "DeploymentId": {
                    "Ref": "Deployment"
                },
                "ApiId": {
                    "Ref": "Diagrams"
                }
            }
        },
        "CreateDiagramRoute": {
            "Type": "AWS::ApiGatewayV2::Route",
            "Properties": {
                "ApiId": {
                    "Ref": "Diagrams"
                },
                "RouteKey": "creatediagram",
                "AuthorizationType": "NONE",
                "OperationName": "CreateDiagramRoute",
                "Target": {
                    "Fn::Join": [
                        "/",
                        [
                            "integrations",
                            {
                                "Ref": "CreateDiagramInteg"
                            }
                        ]
                    ]
                }
            }
        },
        "CreateDiagramInteg": {
            "Type": "AWS::ApiGatewayV2::Integration",
            "Properties": {
                "ApiId": {
                    "Ref": "Diagrams"
                },
                "Description": "create diagram Integration",
                "IntegrationType": "AWS_PROXY",
                "IntegrationUri": {
                    "Fn::Sub": "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${CreateDiagramFunction.Arn}/invocations"
                }
            }
        },
        "CreateDiagramFunction": {
            "Type": "AWS::Serverless::Function",
            "Properties": {
                "CodeUri": "s3://godragons-chat/214c2930eefb7d34ab1b223f086d4c32",
                "Handler": "app.handler",
                "MemorySize": 128,
                "Runtime": "nodejs12.x",
                "Environment": {
                    "Variables": {
                        "DIAGRAMS_TABLE_NAME": {
                            "Ref": "DiagramsTable"
                        }
                    }
                },
                "Policies": [
                    {
                        "DynamoDBCrudPolicy": {
                            "TableName": {
                                "Ref": "DiagramsTable"
                            }
                        }
                    }
                ]
            }
        },
        "CreateDiagramPermission": {
            "Type": "AWS::Lambda::Permission",
            "DependsOn": [
                "Diagrams"
            ],
            "Properties": {
                "Action": "lambda:InvokeFunction",
                "FunctionName": {
                    "Ref": "CreateDiagramFunction"
                },
                "Principal": "apigateway.amazonaws.com"
            }
        },
        "GetDiagramsRoute": {
            "Type": "AWS::ApiGatewayV2::Route",
            "Properties": {
                "ApiId": {
                    "Ref": "Diagrams"
                },
                "RouteKey": "getdiagrams",
                "AuthorizationType": "NONE",
                "OperationName": "GetDiagramsRoute",
                "Target": {
                    "Fn::Join": [
                        "/",
                        [
                            "integrations",
                            {
                                "Ref": "GetDiagramsInteg"
                            }
                        ]
                    ]
                }
            }
        },
        "GetDiagramsInteg": {
            "Type": "AWS::ApiGatewayV2::Integration",
            "Properties": {
                "ApiId": {
                    "Ref": "Diagrams"
                },
                "Description": "get diagrams Integration",
                "IntegrationType": "AWS_PROXY",
                "IntegrationUri": {
                    "Fn::Sub": "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GetDiagramsFunction.Arn}/invocations"
                }
            }
        },
        "GetDiagramsFunction": {
            "Type": "AWS::Serverless::Function",
            "Properties": {
                "CodeUri": "s3://godragons-chat/12e2dd77a036a4000c9f0af2d52cd5e8",
                "Handler": "app.handler",
                "MemorySize": 128,
                "Runtime": "nodejs12.x",
                "Environment": {
                    "Variables": {
                        "DIAGRAMS_TABLE_NAME": {
                            "Ref": "DiagramsTable"
                        }
                    }
                },
                "Policies": [
                    {
                        "DynamoDBCrudPolicy": {
                            "TableName": {
                                "Ref": "DiagramsTable"
                            }
                        }
                    },
                    {
                        "Statement": [
                            {
                                "Effect": "Allow",
                                "Action": [
                                    "execute-api:ManageConnections"
                                ],
                                "Resource": [
                                    {
                                        "Fn::Sub": "arn:aws:execute-api:*"
                                    }
                                ]
                            }
                        ]
                    }
                ]
            }
        },
        "GetDiagramsPermission": {
            "Type": "AWS::Lambda::Permission",
            "DependsOn": [
                "Diagrams"
            ],
            "Properties": {
                "Action": "lambda:InvokeFunction",
                "FunctionName": {
                    "Ref": "GetDiagramsFunction"
                },
                "Principal": "apigateway.amazonaws.com"
            }
        },
        "SendMessageRoute": {
            "Type": "AWS::ApiGatewayV2::Route",
            "Properties": {
                "ApiId": {
                    "Ref": "Diagrams"
                },
                "RouteKey": "sendmessage",
                "AuthorizationType": "NONE",
                "OperationName": "SendMessageRoute",
                "Target": {
                    "Fn::Join": [
                        "/",
                        [
                            "integrations",
                            {
                                "Ref": "SendMessageInteg"
                            }
                        ]
                    ]
                }
            }
        },
        "SendMessageInteg": {
            "Type": "AWS::ApiGatewayV2::Integration",
            "Properties": {
                "ApiId": {
                    "Ref": "Diagrams"
                },
                "Description": "send message Integration",
                "IntegrationType": "AWS_PROXY",
                "IntegrationUri": {
                    "Fn::Sub": "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${SendMessageFunction.Arn}/invocations"
                }
            }
        },
        "SendMessageFunction": {
            "Type": "AWS::Serverless::Function",
            "Properties": {
                "CodeUri": "s3://godragons-chat/e0be3973d9f7f38a193f9f27f75770e0",
                "Handler": "app.handler",
                "MemorySize": 128,
                "Runtime": "nodejs12.x",
                "Environment": {
                    "Variables": {
                        "CONNECTIONS_TABLE_NAME": {
                            "Ref": "ConnectionsTable"
                        }
                    }
                },
                "Policies": [
                    {
                        "DynamoDBCrudPolicy": {
                            "TableName": {
                                "Ref": "ConnectionsTable"
                            }
                        }
                    },
                    {
                        "Statement": [
                            {
                                "Effect": "Allow",
                                "Action": [
                                    "execute-api:ManageConnections"
                                ],
                                "Resource": [
                                    {
                                        "Fn::Sub": "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${Diagrams}/*"
                                    }
                                ]
                            }
                        ]
                    }
                ]
            }
        },
        "SendMessagePermission": {
            "Type": "AWS::Lambda::Permission",
            "DependsOn": [
                "Diagrams"
            ],
            "Properties": {
                "Action": "lambda:InvokeFunction",
                "FunctionName": {
                    "Ref": "SendMessageFunction"
                },
                "Principal": "apigateway.amazonaws.com"
            }
        },
        "DisconnectRoute": {
            "Type": "AWS::ApiGatewayV2::Route",
            "Properties": {
                "ApiId": {
                    "Ref": "Diagrams"
                },
                "RouteKey": "$disconnect",
                "AuthorizationType": "NONE",
                "OperationName": "DisconnectRoute",
                "Target": {
                    "Fn::Join": [
                        "/",
                        [
                            "integrations",
                            {
                                "Ref": "DisconnectInteg"
                            }
                        ]
                    ]
                }
            }
        },
        "DisconnectInteg": {
            "Type": "AWS::ApiGatewayV2::Integration",
            "Properties": {
                "ApiId": {
                    "Ref": "Diagrams"
                },
                "Description": "disconnect Integration",
                "IntegrationType": "AWS_PROXY",
                "IntegrationUri": {
                    "Fn::Sub": "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${DisconnectFunction.Arn}/invocations"
                }
            }
        },
        "DisconnectFunction": {
            "Type": "AWS::Serverless::Function",
            "Properties": {
                "CodeUri": "s3://godragons-chat/a3793b189b3cf8f8b24b00afa5870636",
                "Handler": "app.handler",
                "MemorySize": 128,
                "Runtime": "nodejs12.x",
                "Environment": {
                    "Variables": {
                        "CONNECTIONS_TABLE_NAME": {
                            "Ref": "ConnectionsTable"
                        }
                    }
                },
                "Policies": [
                    {
                        "DynamoDBCrudPolicy": {
                            "TableName": {
                                "Ref": "ConnectionsTable"
                            }
                        }
                    }
                ]
            }
        },
        "DisconnectPermission": {
            "Type": "AWS::Lambda::Permission",
            "DependsOn": [
                "Diagrams"
            ],
            "Properties": {
                "Action": "lambda:InvokeFunction",
                "FunctionName": {
                    "Ref": "DisconnectFunction"
                },
                "Principal": "apigateway.amazonaws.com"
            }
        },
        "ConnectRoute": {
            "Type": "AWS::ApiGatewayV2::Route",
            "Properties": {
                "ApiId": {
                    "Ref": "Diagrams"
                },
                "RouteKey": "$connect",
                "AuthorizationType": "NONE",
                "OperationName": "ConnectRoute",
                "Target": {
                    "Fn::Join": [
                        "/",
                        [
                            "integrations",
                            {
                                "Ref": "ConnectInteg"
                            }
                        ]
                    ]
                }
            }
        },
        "ConnectInteg": {
            "Type": "AWS::ApiGatewayV2::Integration",
            "Properties": {
                "ApiId": {
                    "Ref": "Diagrams"
                },
                "Description": "connect Integration",
                "IntegrationType": "AWS_PROXY",
                "IntegrationUri": {
                    "Fn::Sub": "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ConnectFunction.Arn}/invocations"
                }
            }
        },
        "ConnectFunction": {
            "Type": "AWS::Serverless::Function",
            "Properties": {
                "CodeUri": "s3://godragons-chat/afc879d7f31529e98bee886bd4324334",
                "Handler": "app.handler",
                "MemorySize": 128,
                "Runtime": "nodejs12.x",
                "Environment": {
                    "Variables": {
                        "CONNECTIONS_TABLE_NAME": {
                            "Ref": "ConnectionsTable"
                        }
                    }
                },
                "Policies": [
                    {
                        "DynamoDBCrudPolicy": {
                            "TableName": {
                                "Ref": "ConnectionsTable"
                            }
                        }
                    }
                ]
            }
        },
        "ConnectPermission": {
            "Type": "AWS::Lambda::Permission",
            "DependsOn": [
                "Diagrams"
            ],
            "Properties": {
                "Action": "lambda:InvokeFunction",
                "FunctionName": {
                    "Ref": "ConnectFunction"
                },
                "Principal": "apigateway.amazonaws.com"
            }
        }
    }
}